# Build Step 2

Here’s an exhaustive breakdown of everything you’ll need—in terms of tools, libraries, project structure and individual code modules—to turn our wireframe into a working “Stretchy Face” app.

---

## 1. Environment & Tooling

- **Node.js & npm** (v16+ recommended)  
- **Vite** (for fast bundling/dev server)  
- **Vercel CLI** (for one‑command deploys)  

> You’ll also want a modern browser with WebGL support for testing.

---

## 2. Key Dependencies

| Package                          | Purpose                                                      |
|----------------------------------|--------------------------------------------------------------|
| `three`                          | 3D engine & WebGL abstraction                                |
| `@tensorflow-models/facemesh`    | (Or `face-api.js`) for automatic face bounding‑box/crop     |
| `cropperjs`                      | User‑draggable crop UI                                       |
| `dat.gui` (or `lil-gui`)         | Sliders & controls UI                                        |
| `html2canvas`                    | Capture canvas for download/share                           |
| `stats.js` (optional)            | FPS / perf monitoring during dev                            |
| `vercel` (CLI, dev dependency)   | Deploy to Vercel                                             |

```bash
npm install three @tensorflow-models/facemesh cropperjs dat.gui html2canvas stats.js
npm install --save-dev vite vercel
```

---

## 3. Project Structure

```txt
stretchy-face-app/
├── public/
│   └── favicon.ico
├── src/
│   ├── index.html
│   ├── styles.css
│   ├── main.js
│   ├── utils/
│   │   ├── faceDetection.js
│   │   ├── meshDeformer.js
│   │   └── share.js
│   ├── ui/
│   │   ├── cropperUI.js
│   │   └── controlsUI.js
│   └── assets/
│       └── placeholder.jpg
├── .gitignore
├── package.json
├── vite.config.js
└── vercel.json
```

---

## 4. Config Files

### `package.json`

- **Scripts**:  
  - `"dev": "vite"`  
  - `"build": "vite build"`  
  - `"deploy": "vercel --prod"`

### `vite.config.js`

```js
import { defineConfig } from 'vite';

export default defineConfig({
  root: 'src',
  build: {
    outDir: '../dist',
  },
});
```

### `vercel.json`

```json
{
  "builds": [{ "src": "src/index.html", "use": "@vercel/static" }],
  "routes": [{ "src": "/(.*)", "dest": "/index.html" }]
}
```

---

## 5. Core Source Files

### 5.1 `src/index.html`

- File input & drag‑drop area  
- `<canvas id="c"></canvas>` for Three.js  
- Include `main.js` as a module

### 5.2 `src/styles.css`

- Full‑screen canvas  
- Positioning for file input, cropper, GUI panels

### 5.3 `src/main.js`

- **Imports**: Three.js, faceDetection, meshDeformer, cropperUI, controlsUI, share  
- **Init**: scene, camera, renderer, light  
- **Workflow**:  
  1. Wait for user image (via `cropperUI`)  
  2. Run face detection → get cropped canvas  
  3. Create texture & mesh (`meshDeformer.createMesh`)  
  4. Hook pointer events → `meshDeformer.stretchRegion`  
  5. Start render loop → `meshDeformer.updateSprings(dt)`  
  6. Initialize GUI (`controlsUI.init`)  
  7. Wire up “Reset”/“Download” via `share.capture`

### 5.4 `src/utils/faceDetection.js`

- Load `@tensorflow-models/facemesh` (or `face-api.js`)  
- `async function detectFace(imageOrCanvas) → { x,y,width,height }`  
- Returns bounding box for cropping

### 5.5 `src/ui/cropperUI.js`

- Wraps a `<canvas>` + `cropperjs` instance  
- Emits a promise that resolves to a cropped HTMLCanvasElement

### 5.6 `src/utils/meshDeformer.js`

- `function createMesh(texture, width, height, segments)`  
  - Builds `PlaneGeometry` (or hemisphere), uv’d to the face  
  - Stores `originalPos` and allocates `velocities`  
- `function stretchRegion(from, to, radius, strength)`  
- `function updateSprings(dt, kStiff, damping)`  
- Exposes methods to reset mesh

### 5.7 `src/ui/controlsUI.js`

- Creates a `dat.GUI` panel  
- Sliders for:  
  - Brush radius  
  - Stretch strength  
  - Spring stiffness & damping  
- Buttons for: Reset, Download, Share

### 5.8 `src/utils/share.js`

- `function capture(canvas) → Promise<blob>` via `html2canvas` or `canvas.toBlob`  
- Triggers download or uses `navigator.share()` on supported mobile

---

## 6. Putting It All Together

1. **Dev**  

   ```bash
   npm run dev
   # open http://localhost:5173
   ```

2. **Build**  

   ```bash
   npm run build
   # dist/ contains your static site
   ```

3. **Deploy**  

   ```bash
   npm run deploy
   # live at https://your-app.vercel.app
   ```

---

## 7. (Optional) Extras & Testing

- **TypeScript**: rename `.js` → `.ts`, add `tsconfig.json`  
- **Unit Tests**: Jest for `meshDeformer` math  
- **CI/CD**: GitHub Actions to auto‑deploy on merge to `main`  
- **Performance**: simplify mesh on mobile devices, toggle `antialias: false`  

---

With this scaffold you’ll have every piece—project setup, build config, UI modules, face detection, mesh deformation and sharing—to implement the full stretchy‑face experience end‑to‑end. Let me know if you’d like code samples for any of these modules!
